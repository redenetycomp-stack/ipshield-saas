<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPShield Pro - Auditoria Completa</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #1a2a3a; --secondary: #27ae60; --danger: #e74c3c; --warning: #f39c12; --light: #f8f9fa; }
        body { font-family: 'Inter', sans-serif; background: #eef2f5; margin: 0; color: #333; }
        .container { max-width: 1300px; margin: 0 auto; padding: 15px; }
        
        /* Cabe√ßalho e Navega√ß√£o */
        .header { background: var(--primary); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .nav-tabs { display: flex; background: #2c3e50; overflow-x: auto; padding: 0 15px; gap: 5px; }
        .tab-btn { color: #bdc3c7; border: none; background: none; padding: 16px; font-weight: 600; cursor: pointer; white-space: nowrap; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn.active { color: white; border-bottom-color: var(--secondary); background: rgba(255,255,255,0.05); }
        
        /* Conte√∫do */
        .content { background: white; padding: 25px; border-radius: 0 0 12px 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Filtros Inteligentes */
        .filter-section { background: var(--light); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd; display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 150px; }
        .filter-group label { font-size: 11px; font-weight: bold; color: #666; text-transform: uppercase; }

        /* Tabela Pro */
        .table-res { width: 100%; overflow-x: auto; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f1f3f5; padding: 15px 12px; text-align: left; font-size: 12px; color: #444; border-bottom: 2px solid #dee2e6; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }
        
        /* Badges e Alertas */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .recorrencia { background: #fff5f5; color: var(--danger); border: 1px solid #feb2b2; padding: 2px 6px; border-radius: 10px; font-weight: bold; }
        
        @media (max-width: 768px) { .grid-stats { grid-template-columns: 1fr; } .filter-group { min-width: 100%; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>üõ°Ô∏è IPShield <span style="font-weight: 100;">Vistoria Final</span></h2>
        <div id="status-mcc" class="badge" style="background: var(--secondary);">MCC: ATIVA</div>
    </div>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="tab(event, 'dash')">üìä MONITORAMENTO</button>
        <button class="tab-btn" onclick="tab(event, 'extorno')">üí∞ ESTORNOS (GCLID)</button>
        <button class="tab-btn" onclick="event.preventDefault(); tab(event, 'raiz')">üö´ RA√çZES</button>
        <button class="tab-btn" onclick="tab(event, 'config')">üë• CLIENTES</button>
    </div>

    <div class="content">
        <div id="dash" class="tab-panel active">
            <div class="filter-section">
                <div class="filter-group">
                    <label>Per√≠odo</label>
                    <select id="f-periodo" onchange="loadData()">
                        <option value="24h">√öltimas 24 Horas</option>
                        <option value="7d">√öltimos 7 Dias</option>
                        <option value="30d">√öltimos 30 Dias</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Site</label>
                    <select id="f-site" onchange="loadData()"><option value="all">Todos os Sites</option></select>
                </div>
                <div class="filter-group">
                    <label>Diagn√≥stico</label>
                    <select id="f-diag" onchange="loadData()">
                        <option value="FRAUDE">Somente Ataques</option>
                        <option value="all">Todo o Tr√°fego</option>
                    </select>
                </div>
                <button onclick="loadData()" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">üîç ATUALIZAR</button>
            </div>

            <div class="table-res">
                <table id="main-table">
                    <thead>
                        <tr>
                            <th>IP / RECORR√äNCIA</th>
                            <th>PROVEDOR/CIDADE</th>
                            <th>SITE</th>
                            <th>DATA E HORA</th>
                            <th>P√ÅGINA ACESSADA</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="extorno" class="tab-panel">
            <div style="background: #eef2ff; border: 1px solid #c3dafe; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin:0; color: #1e40af;">üìå Instru√ß√µes de Estorno</h4>
                <p style="font-size: 13px; color: #374151;">Use os c√≥digos GCLID abaixo para contestar no suporte do Google Ads. Isso prova que o clique veio de uma rede suspeita ou repetitiva.</p>
            </div>
            <table id="gclid-table">
                <thead><tr><th>DATA</th><th>IP</th><th>SITE</th><th>GCLID</th><th>A√á√ÉO</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="raiz" class="tab-panel">
            <h3>üö´ Bloqueio de Raiz de IP</h3>
            <p>Bloqueie faixas inteiras de IPs de um mesmo provedor.</p>
            <div id="sugestao-raiz-list"></div>
        </div>

        <div id="config" class="tab-panel">
            <h3>üë• Gerenciamento de Clientes</h3>
            <div id="client-list"></div>
        </div>
    </div>
</div>

<script>
    const _supabase = supabase.createClient('https://xirrtonafivrphrzufbq.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhpcnJ0b25hZml2cnBocnp1ZmJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMDgxMTgsImV4cCI6MjA4NjU4NDExOH0.Fl5QjNnT9SAgW-PmL1gcImCes8r6JJAS6Rrz2Q6FQkE');

    function tab(e, id) {
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        e.currentTarget.classList.add('active');
    }

    async function loadData() {
        const site = document.getElementById('f-site').value;
        const diag = document.getElementById('f-diag').value;
        const periodo = document.getElementById('f-periodo').value;

        // L√≥gica de Datas
        let dias = periodo === '7d' ? 7 : (periodo === '30d' ? 30 : 1);
        let dataCorte = new Date();
        dataCorte.setDate(dataCorte.getDate() - dias);

        let query = _supabase.from('visits').select('*').gte('created_at', dataCorte.toISOString());
        
        if (site !== 'all') query = query.eq('site_id', site);
        if (diag !== 'all') query = query.eq('diagnostico', diag);

        const { data, error } = await query.order('created_at', { ascending: false });
        
        if (data) {
            // Conta recorr√™ncia de IP
            const ipCounts = {};
            data.forEach(v => ipCounts[v.ip] = (ipCounts[v.ip] || 0) + 1);

            document.querySelector('#main-table tbody').innerHTML = data.map(v => `
                <tr>
                    <td><b>${v.ip}</b> <span class="recorrencia">${ipCounts[v.ip]}x</span></td>
                    <td><small>${v.city || '---'}</small><br><b>${v.region || 'Desconhecido'}</b></td>
                    <td>${v.site_id}</td>
                    <td>${new Date(v.created_at).toLocaleString()}</td>
                    <td><div style="width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${v.page_url || 'Home'}</div></td>
                    <td><span class="badge" style="background:${v.diagnostico==='FRAUDE'?'var(--danger)':'var(--secondary)'}; color:white">${v.diagnostico}</span></td>
                </tr>
            `).join('');

            // Tabela GCLID
            const gclids = data.filter(v => v.gclid);
            document.querySelector('#gclid-table tbody').innerHTML = gclids.map(v => `
                <tr>
                    <td>${new Date(v.created_at).toLocaleDateString()}</td>
                    <td>${v.ip}</td>
                    <td>${v.site_id}</td>
                    <td style="font-family:monospace; font-size:10px">${v.gclid}</td>
                    <td><button onclick="navigator.clipboard.writeText('${v.gclid}')">Copiar</button></td>
                </tr>
            `).join('');
        }
    }

    async function init() {
        // Carrega sites no filtro
        const { data } = await _supabase.from('ipshield_config').select('site_nome');
        if(data) data.forEach(s => {
            const opt = document.createElement('option');
            opt.value = opt.innerText = s.site_nome;
            document.getElementById('f-site').appendChild(opt);
        });
        loadData();
    }

    init();
</script>
</body>
</html>
